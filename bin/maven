#!/bin/bash

#///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
#
#  Â© 2011-2021 Telenav, Inc.
#  Licensed under Apache License, Version 2.0
#
#///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

maven()
{
    local arguments=("$@")

    local log_file
    local log_level
    local temporary_folder
    local exit_code
    local last_log_link

    log_level="${MAVEN_LOG_LEVEL:-info}"
    temporary_folder="${TMPDIR:-/tmp}"
    log_file=$temporary_folder/maven-$(date '+%s')-$(script).log

    # shellcheck disable=SC2086
    mvn \
      -Dorg.slf4j.simpleLogger.logFile="${log_file}" \
      -Dorg.slf4j.simpleLogger.defaultLogLevel="${log_level}" \
      -Dorg.slf4j.simpleLogger.cacheOutputStream=false \
      ${arguments[*]} || exit 1 2>&1 | grep -v "SLF4J: "

    last_log_link=$temporary_folder/maven-last.log
    exit_code=$?

    rm -f "$last_log_link"
    ln -s "$log_file" "$last_log_link"

    if [ $exit_code -ne 0 ]; then
        echo " " 1>&2
        echo "mvn ${arguments[*]}" 1>&2
        echo " " 1>&2
        echo "Maven execution failed with exit code ${exit_code}" 1>&2
        echo "A complete log is in ${log_file}" 1>&2
        echo "The last maven log is always linked as maven-last.log in the system temp folder $temporary_folder" 1>&2
        exit $exit_code
    fi

    return $exit_code
}

maven ${*}
