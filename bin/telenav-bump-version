#!/bin/bash

#///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
#
#  Â© 2011-2021 Telenav, Inc.
#  Licensed under Apache License, Version 2.0
#
#///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

source "${TELENAV_WORKSPACE}/bin/telenav-functions"

if [ -n "$1" ]; then
    if [ '--help' = $1 ]; then
        echo "cactus-simple-bump-version $(cactus_version)" 1>&2
        echo 1>&2
        echo '	Bump the version of the Maven project family it is invoked against' 1>&2
        exit 0
    fi
fi

run_maven()
{
  CACTUS_LOG_LEVEL="${CACTUS_LOG_LEVEL:-info}"
  TEMP="${TMPDIR:-/tmp}"
  LOG_FILE=$TEMP/cactus-$(date '+%s')-$(basename $0).log

  mvn \
    --batch-mode \
    --no-transfer-progress \
    -Dorg.slf4j.simpleLogger.logFile=${LOG_FILE} \
    -Dorg.slf4j.simpleLogger.defaultLogLevel=${CACTUS_LOG_LEVEL} \
    -Dorg.slf4j.simpleLogger.cacheOutputStream=false ${MAVEN_ARGS}

  EXIT_CODE=$?
  LAST_LOG_LINK=$TEMP/cactus-last.log

  rm -f $LAST_LOG_LINK
  ln -s $LOG_FILE $LAST_LOG_LINK

  if [ $EXIT_CODE -ne 0 ]; then
    echo "Maven execution failed with exit code ${EXIT_CODE}" 1>&2
    echo "A complete log file is in ${LOG_FILE}"  1>&2
    echo "The last cactus log is always linked as cactus-last.log in the system temp folder $TEMP" 1>&2
  fi

  exit $EXIT_CODE
}

MAVEN_ARGS="-Dcactus.commit-changes=true \
    -Dcactus.superpom.bump.policy=ignore \
    -Dcactus.commit-changes=false \
    -Dcactus.bump.published=false \
    -Dcactus.include-root=true \
    -Dcactus.push=false \
    -Dcactus.scope=family \
    com.telenav.cactus:cactus-maven-plugin:$(cactus_version):bump-version"

run_maven